---
title: "Tasa de mortalidad por causa externa en Costa Rica: Un análisis de la serie temporal 2000 - 2017"
author:
  - name: César Gamboa Sanabria - Stefany Matarrita Muñoz
    affiliation: Universidad de Costa Rica
    footnote: "email: cesar.gamboasanabria@ucr.ac.cr | LinkedIn: https://linkedin.com/in/cgamboasanabria | Github: https://github.com/cgamboasanabria"
address:
  - code: Universidad de Costa Rica
    address: Escuela de Estadística, Universidad de Costa Rica
header-includes:  \usepackage[spanish]{babel}
bibliography: mybibfile.bib
output: rticles::elsevier_article
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache=TRUE, 
                      warning = FALSE, message = FALSE)
```

# Preguntas teóricas

## 1.   

La representación de la ecuación de Wold viene dada por:

$$
x_t = \sum\limits_{j=0}^\infty \psi_j\epsilon_{t-j}+k_t 
$$
donde,
$$
\psi_j\ \text{satisface que}\  \psi_0=0 \\
\psi_j \in \mathbb{R} \\
\sum\limits_{j=0}^\infty \psi_j^2<\infty \\
$$
$\epsilon_t$ es el error resultante de predecir$x_t$ con una función lineal de los rezagos de $x_t$, el cual es un ruido blanco constituido por variables aleatorias independientes e igualmente distribuidas (denotado como i.i.d en adelante) N(0,$\sigma_{\epsilon}^2$)

Como se puede observar esta ecuación consta de dos componentes:

* La suma de los errores pasados son el **componente estocástico** lineal de $x_t$ .
* El término $k_t$ representa **componente lineal determinístico** tal que cov($k_t$,$\epsilon_{t-j}$)=0.

El teorema de Wold establece que *omitiendo el componente determinista $k_t$,  cualquier proceso estacionario puede escribirse como una suma ponderada infinita de los errores (ecuación de Wold), representado por un ruido blanco de varianza finita*.

Su importancia entonces, radica en que permite a los modelos ARIMA pronosticar utilizando los rezagos pasados, bajo el supuesto de estacionariedad. 

Además gracias a que este teorema establece que tener conocimiento de $\epsilon_t,\epsilon_{t-1},\epsilon_{t-2}...$ es equivalente a conocer los valores pasados de $x_t$, se pueden utilizar los rezagos para pronosticar.

## 2.   

La función de autocorrelación total, denominada autocorrelación porque usa los valores de la misma serie, establece la correlación existente entre los valores de $x_t$ y $x_{t-k}$, donde k representa el número de rezagos, su fórmula de cálculo viene dada por:
$$
\rho_k = \frac{Cov(x_t,x_{t-k})}{[V(x_t)]^{1/2}[V(x_t+x_{t-k})]^{1/2}} = \frac{\gamma_k}{\gamma_0}
$$

Mientras que la función de autocorrelación parcial en el rezago K mide el grado de asociación lineal entre $x_t$ y $x_{t-k}$  cuando los efectos de los otros rezagos 1,2,...,k-1, han sido eliminados. Como sugiere su interpretación para calcularlos se utilizan los coeficientes de regresión de $x_{t-k}$ estimados mediante *mínimos cuadrados ordinarios*:

$$
x_t = \phi_{k1}x_{t-1} + \phi_{k2}x_{t-2} +...+\phi_{kk}x_{t-k} + u_t
$$
Como se describió, por definición estas son distintas, así  su forma de cálculo.Sin embargo la importancia de las dos es la misma, y radica en que gracias a ellas se puede identificar si el proceso es AR(p),MA(q) o ARMA(p,q), pues son las que dan el conocimiento del proceso que genera la muestra de los valores observados de la serie.

## 3.   

Si el proceso es estacionaria en el sentido fuerte, la media y la varianza no dependen del tiempo, entonces la función de distribución y sus parámetros es igual sin importar el intervalo de tiempo que se tome:

$$
F(y_1...y_{t_{n}})=F(y_{t_{1+k}}...y_{t_{n}+k})
$$

## 4.   

Una intervención de impulso es cuando el nivel de una observación en un momento t es afectada, cuando esto sucede, se observa ya sea una caída o un alza, que desaparece sin influir sobre el comportamiento posterior de la serie.

Una intervención de escalón influye de manera sostenida sobre el nivel de la serie, sin afectar la estructura de la parte estocástica.

Se utilizan variables de control para representar las intervenciones ya que no pertenecen propiamente a la parte estocástica de la serie, pues usualmente se deben a factores exógenos que son ajenos al comportamiento histórico de la serie.Si no se incluyen estas variables de control puede afectarse la identificación de los ARIMA así como la estimación de los parámetros.

## 5.   

### a.    

Como $u_t$ es ruido blanco se cumple que:
(a) $E(u_t)=0$
(b) $E(u_tu_{t-j}=0)$ para $j\ne0$ 
(c) $E(u_t^2)=\sigma_u^2$.

Dado lo anterior, la esperanza del proceso es equivalente a:

\begin{equation}
\begin{split}
&E[x_t]=E[(1-0.4B)u_t]=E[(u_t-0.4u_{t-1})]\\
&\qquad= E[u_t]-E[0.4u_t]\\ 
&\qquad= 0 - 0.4E[(u_t)]\\
&\qquad= 0-0.4*0\\
&\qquad= 0 
\end{split}
\end{equation}

La varianza viene dada por:
\begin{equation}
\begin{split}
&var[(u_t-0.4u_{t-1})]\\
&\qquad=var[u_t]+(-0.4)^2var[u_{t-1}]+2*-0.4cov((u_t,u_{t-1})) 
\end{split}
\end{equation}

Dado que se asume  que los errores son ruido blanco i.i.d $N(0,\ {\sigma^2})$ entonces:

\begin{equation}
\begin{split}
&cov(u_t,u_{t-1})=0\\
&\qquad var(u_t)=var(u_{t-1})
\end{split}
\end{equation}
Por ende,

\begin{equation}
\begin{split}
&var[u_t]+(-0.4)^2var[u_{t-1}]+2*-0.4cov((u_t,u_{t-1}))\\
&\qquad=(var[u_t]+0.16var[u_{t-1}]+0\\
&\qquad=(1+0.16)var[u_t]\\
&\qquad=1.16var[u_t]
\end{split}
\end{equation}

El proceso es estacionario porque $x_t$ posee media y varianza constante, es decir sus momentos son independiente del tiempo.

### b.    

Se tiene un proceso MA(1), con la siguiente forma:

$$
x_t=(1-0.4B)u_t=u_t-0.4u_{t-1}
$$
La función autocovarianza al rezago k para este caso viene dada por:

$$
\gamma(k)=cov(X_{t},X_{t-k})=E[(X_{t}-E[X_t])(X_{t-k}-E[X_{t-k}]) ]
$$
En el paso anterior se corroboró que $X_t$ es estacionaria,por ende se deduce que: $E[X_t]=E[X_{t-k}]=0$. 

Dado lo anterior la covarianza se puede reescribir como:

\begin{equation}
\begin{split}
&\gamma(k)=cov(X_{t},X_{t-k})=E[(X_{t}-E[X_t])(X_{t-k}-E[X_{t-k}])]\\
&\qquad=E[(X_{t})(X_{t-k})]\\
&\qquad=E[ (u_t  -0.4u_{t-1})(u_{t-k}  -0.4u_{t-k-1})]\\ 
&\qquad=E[u_tu_{t-k}-0.4u_{t-1}u_{t-k}-0.4u_{t-k-1}u_{t}+0.16u_{t-1}u_{t-k-1}]\\
&\qquad=E[u_tu_{t-k}]-0.4E[u_{t-1}u_{t-k}]-0.4E[u_{t-k-1}u_{t}]+0.16E[u_{t-1}u_{t-k-1}]  
\end{split}
\end{equation}
Si k=0:

\begin{equation}
\begin{split}
&\gamma(0)= E[u_tu_{t}]-0.4E[u_{t-1}u_{t}]-0.4E[u_{t-1}u_{t}]+0.16E[u_{t-1}u_{t-1}] \\
&\qquad=\sigma_u^2 -0.4*0-0.4*0+0.16\sigma_{u}^2\\
&\qquad=\sigma_u^2+0.16\sigma_u^2\\
&\qquad=1.16\sigma_u^2
\end{split}
\end{equation}

Si k=1

\begin{equation}
\begin{split}
&\gamma(1)=E[u_tu_{t-1}]-0.4E[u_{t-1}u_{t-1}]-0.4E[u_{t-2}u_{t}]+0.16E[u_{t-1}u_{t-2}]\\
&\qquad=0-0.4*\sigma_u^2-0.4*0+0.16*0\\
&\qquad=-0.4*\sigma_u^2
\end{split}
\end{equation}

Si k>1, $\gamma(k)=0$, corroboremos para el caso de k=2

\begin{equation}
\begin{split}
&\gamma(2)= E[u_tu_{t-2}]-0.4E[u_{t-1}u_{t-2}]-0.4E[u_{t-3}u_{t}]+0.16E[u_{t-1}u_{t-3}]\\
&\qquad=0-0.4*0-0.4*0+0.16*0\\
&\qquad=0
\end{split}
\end{equation}

Finalmente, la función de autocovarianza viene dada por:

$$
\gamma_t(k) = \left \{ \begin{matrix}
1.16\sigma_{u}^2& \mbox{si }k=0\\ 
0.4\sigma_{u}^2& \mbox{si }k=1 
\\ 
0 & \ k>1\end{matrix}\right.  
$$

La autocorrelación se define como:

\begin{equation}
\begin{split}
&\rho(k)=cor(x_t,x_{t-k})\\
&\qquad=\frac{cov(x_t,x_{t-k})}{[var(x_t)]^{1/2}[var(x_{t-k})]^{1/2}}\\
&\qquad=\frac{\gamma(k)}{[1.16\sigma_u^2]^{1/2}[1.16\sigma_u^2]^{1/2}}\\
&\qquad=\frac{\gamma(k)}{1.16\sigma_u^2}\\
&\qquad=\frac{\gamma(k)}{\gamma(0)}
\end{split}
\end{equation}

La función autocorrelación al rezago k es equivalente a:

$$
\rho_k = \left \{ \begin{matrix}
\frac{\gamma(0)}{\gamma(0)}=\frac{0.4\sigma_{u}^2}{0.4\sigma_{u}^2}=1& \mbox{si }k=0\\ 
\frac{\gamma(1)}{\gamma(0)}=\frac{0.4\sigma_{u}^2}{1.16\sigma_{u}^2}=0.3448276& \mbox{si }k=1
\\ 
\frac{\gamma(k)}{\gamma(0)}=\frac{0}{\gamma(0)}=0 & \ k>1\end{matrix}\right. 
$$

### c.    

Expresión de la función de autocorrelación parcial utilizando las ecuaciones de Yule-Walker:

$$
\rho_1=\phi_{k1}+\phi_{k2}\rho_{1}
$$

## 6.   

### a.    

Partiendo de que $u_t$ es ruido blanco i.i.d, se cumple que:
(a) $E(u_t)=0$
(b) $E(u_tu_{t-j}=0)$ para $j\ne0$ 
(c) $E(u_t^2)=\sigma_u^2$


\begin{equation}
\begin{split}
&E[x_{t+1}]=E[(1-0.7B+0.1B^2)u_{t+1}]=E[(u_{t+1}-0.7u_{t}+0.1u_{t-1})]
\\
&\qquad=E[u_{t+1}]-0.7E[u_{t}]+0.1E[u_{t-1}]\\
&\qquad=0-0.7*0+0.1*0\\
&\qquad=0
\end{split}
\end{equation}

\begin{equation}
\begin{split}
&var[x_{t+1}]=var[(1-0.7B+0.1B^2)u_{t+1}]\\
&\qquad=var[(u_{t+1}-0.7u_{t}+0.1u_{t-1})] \\
&\qquad=var[(u_{t+1}]+(-0.7)^2var[u_{t}]+(0.1)^2var[u_{t-1})]\\
&\qquad+2[-0.7cov(u_{t+1},u_{t})+0.1cov(u_{t+1},u_{t-1})-0.7*0.1cov(u_{t},u_{t-1})]\\
&\qquad=\sigma_{u}^2+0.49\sigma_{u}+0.01\sigma_{u}+2*[-0.7*0+0.1*0-0.07*0]\\
&\qquad=1.5\sigma_{u}^2
\end{split}
\end{equation}

Como se pudo demostrar la media y la varianza son constantes, por ende sus momentos son invariantes al tiempo,  el proceso es estacionario.

### b.    

Se tiene un proceso MA(2), con la siguiente forma:

\begin{equation}
\begin{split}
&x_{t+1}=(1-0.7B+0.1B^2)u_{t+1}=u_{t+1}-0.7u_{t}+0.1u_{t-1}
\end{split}
\end{equation}

La función autocovarianza al rezago k para este caso viene dada por:

\begin{equation}
\begin{split}
&\gamma(k)=cov(X_{t+1},X_{t+1-k})=E[(X_{t+1}-E[X_t+1])(X_{t+1-k}-E[X_{t+1-k}]) ]
\end{split}
\end{equation}

En el paso anterior se corroboró que $X_t$ es estacionaria,por ende se deduce que: $E[X_{t+1}]=E[X_{t+1-k}]=0$. 

Además dado que $u_t$ es ruido blanco se cumple que:
(a) $E(u_t)=0$
(b) $E(u_tu_{t-j}=0)$ para $j\ne0$ 
(c) $E(u_t^2)=\sigma_u^2$

Dado lo anterior la covarianza se puede reescribir como:

\begin{equation}
\begin{split}
&\gamma(k)=cov(X_{t+1},X_{t+1-k})\\
&=E[(X_{t+1}-E[X_t+1])(X_{t+1-k}-E[X_{t+1-k}])]\\
&\qquad=E[(X_{t+1})(X_{t+1-k})] \\
&\qquad=E[u_{t+1}-0.7u_{t}+0.1u_{t-1})(u_{t+1-k}-0.7u_{t-k}+0.1u_{t-1-k})] \\ 
&\qquad=E[ u_{t+1}u_{t+1-k}-0.7u_{t}u_{t+1-k}+0.1u_{t-1}u_{t+1-k} \\ 
&\qquad-0.7u_{t-k}u_{t+1}-0.7u_{t}*-0.7u_{t-k}+0.1u_{t-1}*-0.7u_{t-k}\\
&\qquad+0.1u_{t-1-k}u_{t+1}-0.7u_{t}*0.1u_{t-1-k}+0.1u_{t-1}*0.1u_{t-1-k}]\\
&\qquad=E[ u_{t+1}u_{t+1-k}-0.7u_{t}u_{t+1-k}+0.1u_{t-1}u_{t+1-k} \\ 
&\qquad-0.7u_{t-k}u_{t+1}+0.49u_{t}u_{t-k}-0.07u_{t-1}u_{t-k}\\
&\qquad+0.1u_{t-1-k}u_{t+1}-0.07u_{t}u_{t-1-k}+0.01u_{t-1}u_{t-1-k}]
\end{split}
\end{equation}

Si k=0:

\begin{equation}
\begin{split}
&\gamma(0)=E[ u_{t+1}u_{t+1}-0.7u_{t}u_{t+1}+0.1u_{t-1}u_{t+1} \\ 
&\qquad-0.7u_{t}u_{t+1}+0.49u_{t}u_{t}-0.07u_{t-1}u_{t}\\
&\qquad+0.1u_{t-1}u_{t+1}-0.07u_{t}u_{t-1}+0.01u_{t-1}u_{t-1}]  \\
&\qquad=E[u_{t+1}u_{t+1}]-0.7E[u_{t}u_{t+1}]+0.1E[u_{t-1}u_{t+1}] \\ 
&\qquad-0.7E[u_{t}u_{t+1}]+0.49E[u_{t}u_{t}]-0.07E[u_{t-1}u_{t}]\\
&\qquad+0.1E[u_{t-1}u_{t+1}]-0.07E[u_{t}u_{t-1}]+0.01E[u_{t-1}u_{t-1}] \\
&\qquad=\sigma_u^2-0.7*0+0.1*0\\
&\qquad 0.7*0+0.49\sigma_u^2-0.07*0\\
&\qquad+0.1*0-0.07*0+0.01*\sigma_u^2\\
&\qquad=(1+0.49+0.01)\sigma_u^2\\
&\qquad=1.5\sigma_u^2
\end{split}
\end{equation}


Si k=1
\begin{equation}
\begin{split}
&\gamma(2)=E[ u_{t+1}u_{t}-0.7u_{t}u_{t}+0.1u_{t-1}u_{t} \\ 
&\qquad-0.7u_{t-1}u_{t+1}+0.49u_{t}u_{t-1}-0.07u_{t-1}u_{t-1}\\
&\qquad+0.1u_{t-2}u_{t+1}-0.07u_{t}u_{t-2}+0.01u_{t-1}u_{t-2}]\\ 
&\qquad=E[u_{t+1}u_{t}]-0.7E[u_{t}u_{t}]+0.1E[u_{t-1}u_{t}] \\ 
&\qquad-0.7E[u_{t-1}u_{t+1}]+0.49E[u_{t}u_{t-1}]-0.07E[u_{t-1}u_{t-1}]\\
&\qquad+0.1E[u_{t-2}u_{t+1}]-0.07E[u_{t}u_{t-2}]+0.01E[u_{t-1}u_{t-2}]\\ 
&\qquad=0-0.7\sigma_u^2+0.1*0 \\
&\qquad-0.7*0+0.49*0-0.07\sigma_u^2\\
&\qquad+0.1*0-0.07*0+0.01*0\\
&\qquad=(-0.7-0.07)\sigma_u^2\\
&\qquad=-0.77\sigma_u^2
\end{split}
\end{equation}

Si k=2

\begin{equation}
\begin{split}
&\gamma(2)=E[ u_{t+1}u_{t-1}-0.7u_{t}u_{t-1}+0.1u_{t-1}u_{t-1} \\ 
&\qquad-0.7u_{t-2}u_{t+1}+0.49u_{t}u_{t-2}-0.07u_{t-1}u_{t-2}\\
&\qquad+0.1u_{t-3}u_{t+1}-0.07u_{t}u_{t-3}+0.01u_{t-1}u_{t-3}]\\
&\qquad=E[u_{t+1}u_{t-1}]-0.7E[u_{t}u_{t-1}]+0.1E[u_{t-1}u_{t-1}] \\ 
&\qquad-0.7E[u_{t-2}u_{t+1}]+0.49E[u_{t}u_{t-2}]-0.07E[u_{t-1}u_{t-2}]\\
&\qquad +0.1E[u_{t-3}u_{t+1}]-0.07E[u_{t}u_{t-3}]+0.01E[u_{t-1}u_{t-3}]\\
&\qquad =0-0.7*0+0.1*\sigma_u^2*0\\
&\qquad+0.1*0-0.07*0+0.01*0\\
&\qquad+0.1*0-0.07*0+0.01*0\\
&\qquad=0.1\sigma_u^2
\end{split}
\end{equation}

Si k>1 entonces $\gamma(0)=0$, corroboremos para el caso de k=3

\begin{equation}
\begin{split}
&\gamma(3)=E[ u_{t+1}u_{t-2}-0.7u_{t}u_{t-2}+0.1u_{t-1}u_{t-2} \\ 
&\qquad-0.7u_{t-2}u_{t+1}+0.49u_{t}u_{t-2}-0.07u_{t-1}u_{t-2}\\
&\qquad+0.1u_{t-3}u_{t+1}-0.07u_{t}u_{t-3}+0.01u_{t-1}u_{t-3}]\\
&\qquad=E[u_{t+1}u_{t-2}]-0.7E[u_{t}u_{t-2}]+0.1E[u_{t-1}u_{t-2}] \\ 
&\qquad-0.7E[u_{t-2}u_{t+1}]+0.49E[u_{t}u_{t-2}]-0.07E[u_{t-1}u_{t-2}]\\
&\qquad+0.1E[u_{t-3}u_{t+1}]-0.07E[u_{t}u_{t-3}]+0.01E[u_{t-1}u_{t-3}]\\
&\qquad=0
\end{split}
\end{equation}

Finalmente, la función de autocovarianza se puede definir como:

$$
\gamma_t(k) = \left \{ \begin{matrix}
1.5\sigma_{u}^2& \mbox{si }k=0\\ 
-0.77\sigma_{u}^2& \mbox{si }k=1\\ 
0.1\sigma_{u}^2& \mbox{si }k=2\\ 
0 & \ k>2\end{matrix}\right.  
$$

La autocorrelación se define como:

\begin{equation}
\begin{split}
&\rho(k)=cor(x_t,x_{t-k})\\
&\qquad=\frac{cov(x_t,x_{t-k})}{[var(x_t)]^{1/2}[var(x_{t-k})]^{1/2}} \\
&\qquad=\frac{\gamma(k)}{[1.5\sigma_u^2]^{1/2}[1.5\sigma_u^2]^{1/2}}\\
&\qquad=\frac{\gamma(k)}{1.5\sigma_u^2}\\
=\frac{\gamma(k)}{\gamma(0)}
\end{split}
\end{equation}

La función autocorrelación al rezago k es equivalente a:

$$
\rho_k = \left \{ \begin{matrix}
\frac{\gamma(0)}{\gamma(0)}=\frac{1.5\sigma_u^2}{1.5\sigma_u^2}=1& \mbox{si }k=0\\ 
\frac{\gamma(1)}{\gamma(0)}=\frac{-0.77\sigma_{u}^2}{1.5\sigma_{u}^2}=-0.5133333& \mbox{si }k=1\\ 
\frac{\gamma(2)}{\gamma(0)}=\frac{0.1\sigma_{u}^2}{1.5\sigma_{u}^2}=0.06666667& \mbox{si }k=2\\ 
\frac{\gamma(k)}{\gamma(0)}=\frac{0}{\gamma(0)}=0 & \ k>1\end{matrix}\right. 
$$

Como las únicas correlaciones no nulas son $\rho_1$ y $\rho_2$ , se dice que la memoria del proceso son dos períodos.


## 7.   

Se tiene un proceso AR(1), de la siguiente forma:

$$
y_t=0.8y_{t-1}+\epsilon_t
$$

La esperanza de este proceso es:

\begin{equation}
\begin{split}
&E[y_t]=E[0.8y_{t-1}+\epsilon_t]\\
&\qquad\Rightarrow E[y_t]= 0.8E[y_{t-1}]+E[\epsilon_t]]\\
&\qquad\Rightarrow E[y_t]=0.8E[y_{t-1}]+0\\
&\qquad\Rightarrow E[y_t]=0.8E[y_{t-1}]
\end{split}
\end{equation}

Para que el proceso sea estacionario, la media debe ser constante y finita en el tiempo, esto implica que:
\begin{equation}
\begin{split}
&\Rightarrow E[y_t]=0.8E[y_{t}]\\
&\qquad\Rightarrow E[y_t]-0.8E[y_{t-1}]=0\\
&\qquad\Rightarrow E[y_t](1-0.8)=0\\
&\qquad\Rightarrow E[y_t]=0/(1-0.8)\\
&\qquad\Rightarrow E[y_t]=0
\end{split}
\end{equation}

Por otro lado la varianza viene dada por:

\begin{equation}
\begin{split}
&var[y_t]=var[0.8y_{t-1}+\epsilon_t]\\
&\qquad\Rightarrow var[y_t]=(0.8)^2var(y_{t-1})+\sigma_{\epsilon}^2
\end{split}
\end{equation}

Bajo estacionariedad var[$y_t$]=var[$y_{t-1}$]

\begin{equation}
\begin{split}
&var[y_t]=(0.8)^2var(y_{t-1})+\sigma_{\epsilon}^2\\
&\qquad\Rightarrow var[y_t]-(0.8)^2var(y_{t-1})=\sigma_{\epsilon}^2\\
&\qquad\Rightarrow var[y_t](1-(0.8)^2)=\sigma_{\epsilon}^2\\
&\qquad\Rightarrow var[y_t]=\frac{\sigma_{\epsilon}^2}{(1-(0.8)^2)}
\end{split}
\end{equation}

Para calcular la función de autocorrelación de orden 1,2 y 3 es necesario calcular primeramente a autocovarianza, a continuación se muestra su cálculo:

\begin{equation}
\begin{split}
&\gamma(k)=cov(y_{t},y_{t-k})=E[(y_{t}-E[y_t])(y_{t-k}-E[y_{t-k}])]\\
&\qquad=E[(y_{t}-0)(y_{t-k}-0)]\\
&\qquad=E[y_{t}y_{t-k}]\\
&\qquad=E[(0.8y_{t-1}+\epsilon_t)y_{t-k}]\\
&\qquad=E[0.8y_{t-1}y_{t-k}+\epsilon_ty_{t-k}]\\
&\qquad=0.8E[y_{t-1}y_{t-k}]+E[\epsilon_ty_{t-k}]\\
&\qquad=0.8E[y_{t-1}y_{t-k}]+0\\
&\qquad=0.8E[y_{t-1}y_{t-k}]
\end{split}
\end{equation}

Si k=1

\begin{equation}
\begin{split}
&\gamma(1)=0.8E[y_{t-1}y_{t-1}]\\
&\qquad\Rightarrow \gamma(1)=0.8\gamma(0)\\
&\qquad\Rightarrow \gamma(1)=0.8\gamma(0)=0.8var[y_t]=\frac{0.8\sigma_{\epsilon}^2}{(1-(0.8)^2)}
\end{split}
\end{equation}

Si k=2

\begin{equation}
\begin{split}
&\gamma(2)=0.8E[y_{t-1}y_{t-2}]\\
&\qquad\Rightarrow \gamma(2)=0.8E[y_{t-1}y_{t-1-1}]\\
&\qquad\Rightarrow \gamma(2)=0.8\gamma(1)\\
&\qquad\Rightarrow \gamma(2)=0.8(0.8\gamma(0)\\
&\qquad\Rightarrow \gamma(2)=0.8\frac{0.8\sigma_{\epsilon}^2}{(1-(0.8)^2)}\\
&\qquad=\frac{0.8^2\sigma_{\epsilon}^2}{(1-(0.8)^2)}
\end{split}
\end{equation}

Si k=3

\begin{equation}
\begin{split}
&\gamma(3)=0.8E[y_{t-1}y_{t-3}]\\
&\qquad\Rightarrow \gamma(3)=0.8E[y_{t-1}y_{t-1-2}]\\
&\qquad\Rightarrow \gamma(2)=0.8\gamma(2)\\
&\qquad\Rightarrow \gamma(3)=0.8(0.8(0.8\gamma(0))\\
&\qquad\Rightarrow \gamma(3)=\frac{0.8^3\sigma_{\epsilon}^2}{(1-(0.8)^2)}
\end{split}
\end{equation}

Finalmente:

$$
\gamma_t(k) = \left \{ \begin{matrix}
\frac{\sigma_{\epsilon}^2}{(1-(0.8)^2)}& \mbox{si }k=0\\ 
(0.8)^k\gamma(0)& \mbox{si }k>1\\ 
\end{matrix}\right.  
\Rightarrow
\rho_k = \left \{ \begin{matrix}
\frac{\gamma(0)}{\gamma(0)}=\frac{\frac{\sigma_{\epsilon}^2}{(1-(0.8)^2)}}{\frac{\sigma_{\epsilon}^2}{(1-(0.8)^2)}}=1& \mbox{si }k=0\\ 
\frac{\gamma(1)}{\gamma(0)}=\frac{(0.8)^1\gamma(0)}{\gamma(0)}=0.8& \mbox{si }k=1\\ 
\frac{\gamma(2)}{\gamma(0)}=\frac{(0.8)^2\gamma(0)}{\gamma(0)}=0.64& \mbox{si }k=2\\ 
\frac{\gamma(3)}{\gamma(0)}=\frac{(0.8)^3\gamma(0)}{\gamma(0)}=0.512& \mbox{si }k=3\\ 
\end{matrix}\right. 
$$

# Preguntas prácticas

## 1.

```{r, results='hide'}
#FUnciones previas
load("C:/Users/Dell/OneDrive/Academico/Proyectos/GitHub/Academico/Cursos/SP-1633 Series Cronológicas/Examenes/Parcial II/Funciones.RData")
#load("D:/GitHub/Academico/Parcial2/Funciones.RData")


#Carga de paquetes
paquetes <- c("tidyr", "lubridate", "ggplot2", "ggpmisc",
              "ggseas", "readxl", "astsa", "forecast", 
              "formattable", "gridExtra", "fastDummies", "dplyr")

requeridos(paquetes)

#Lectura de la base

base <- read_excel("C:/Users/Dell/OneDrive/Academico/Proyectos/GitHub/Academico/Cursos/SP-1633 Series Cronológicas/Examenes/Parcial II/Datos examen2.xlsx", sheet = 2)
#base <- read_excel("D:/GitHub/Academico/Parcial2/Datos examen2.xlsx", sheet = 2)

colnames(base) <- c("fecha", "IC")
#Definición de períodos

TS <- ts(base$IC, start = c(2007, 1), end = c(2018, 6), frequency = 12)
```


### a.    

Comprende el pago de los intereses de la deuda del gobierno, esto es, las erogaciones de intereses y comisiones destinadas por las instituciones públicas para cubrir el pago a favor de terceras personas, físicas o jurídicas, del sector privado o del sector público, residentes en el territorio nacional o en el exterior, por la utilización en un determinado plazo de recursos financieros provenientes de los conceptos de emisión y colocación de títulos valores, contratación de préstamos directos, créditos de proveedores, depósitos a plazo y a la vista, intereses por deudas de avales asumidos, entre otros pasivos de la entidad transados en el país o en el exterior. Incluye,  el pago por concepto de otras obligaciones contraídas entre las partes, que no provienen de las actividades normales de financiamiento. Además, los intereses y comisiones por las operaciones normales de los bancos comerciales del sector público, así como las diferencias por tipo de cambio por operaciones financieras; y también el pago de intereses moratorios correspondientes a la deuda pública.  

### b.    

```{r}
TS <- na.interp(TS, lambda="auto")
base <- mutate(base, IC=c(TS))
train <- filter(base, ymd(fecha)<=ymd("2016-06-01"))
train <- ts(train$IC, start=c(2007, 1), frequency = 12)
test <- filter(base, ymd(fecha)>=ymd("2016-07-01"))
test <- ts(test$IC, start=c(2016, 7), frequency = 12)
train.serie <- window(train, 2007)
test.serie <- window(test, 2016)
serie.completa <- window(TS, start=2007)
```

### c.    

```{r}
ggplot(TS)+
  geom_line(color = "#00AFBB", size = 1.3) +
  stat_smooth(color = "#FC4E07", fill = "#FC4E07",
              method = "loess")+
  geom_vline(xintercept = 2010.6, linetype="dashed", color = "red")+
  theme_minimal() +
  theme(text = element_text(size=9),
        axis.text.x = element_text(angle=0, hjust=1)) +
  ggtitle("Gráfico 1: Intereses y comisiones del sector público\nen el periodo 2007-presente") +
  labs(caption="Fuente: SIGAF",
       y="Intereses y comisiones (millones de colones)",
       x="Año") +
  theme(plot.title = element_text(hjust = 0.5, face="plain"),
        plot.caption=element_text(hjust=0, vjust=0.5,
                                  margin=margin(t=1,10,10,10))) +
  #ylim(7,12) +
  scale_x_discrete(expand = c(0,0), limits=c(2007, 2011, 2015, 2018))
```

En el gráfico 1, al hacer un suavizamiento Loess hay un ligero cambio de concavidad a partir de Julio 2010, lo cual sugiere que a partir de este momento los intereses y comisiones inician una tendencia al alza, la cual se sostiene hasta Junio del 2018.

```{r}
base %>% 
  group_by(año=year(fecha), mes=month(fecha, label = TRUE, abbr=FALSE)) %>% 
  summarise(IC) %>% 
  #mutate(mes=factor(mes, labels=c("Febrero - Enero", "Marzo - Febrero",
   #                               "Abril - Marzo", "Mayo - Abril", 
    #                              "Junio - Mayo", "Julio - Junio",
     #                             "Agosto - Julio", "Setiembre - Agosto",
      #                            "Octubre - Setiembre", "Noviembre - Octubre",
       #                           "Diciembre - Noviembre", "Enero - Diciembre"))) %>% 
  ggplot(., aes(x=año, y=IC)) +
  facet_wrap(.~mes, ncol=3) +
  geom_line(color = "#00AFBB", size = 1.3) +
  stat_peaks(colour = "red") +
  stat_peaks(geom = "text", colour = "red", 
             vjust = -0.5) +
  stat_valleys(colour = "blue") +
  stat_valleys(geom = "text", colour = "blue", angle = 20,
               vjust = 0.1, hjust = 1) +
  theme_minimal() +
  theme(text = element_text(size=13),
        axis.text.x = element_text(angle=0, hjust=1)) +
  ggtitle("Gráfico 2: Intereses y comisiones del sector público\nen el periodo 2007-presente según mes") +
  labs(caption="Fuente: SIGAF",
       y="Intereses y comisiones (millones de colones)",
       x="Año") +
  theme(plot.title = element_text(hjust = 0.5, face="plain"),
        plot.caption=element_text(hjust=0, vjust=0.5,
                                  margin=margin(t=1,10,10,10))) +
  #ylim(7, 14) +
  scale_x_discrete(expand = c(0,0), limits=c(2007, 2011, 2015, 2018))
```


El gráfico 2 muestra cómo hay un crecimiento sostenido de los Intereses y comisiones del sector público al final de cada trimestre durante todo el periodo, mientras que se mantiene casi constante durante los primeros dos meses de cada trimestre. La caída más pronunciada se dió en abril del 2015 mientras que la tasa de crecimiento más rápida parece darse al final del primer trimestre.

```{r}
base %>% 
  mutate(IC=BoxCox(c(TS), lambda=1)) %>% 
ggsdc(., aes(x = fecha, y = IC),
         method = "stl", s.window = 7, frequency = 12, type="multiplicative",
         facet.titles = c("Serie Original", "Tendencia", 
                          "Estacionalidad", "Aleatoria")) +
      geom_line(color = "#00AFBB", size = 1.3) +
  labs(x = "", y = "") +
  theme_minimal() +
  theme(text = element_text(size=13),
        axis.text.x = element_text(angle=0, hjust=1),
        plot.title = element_text(size = 12)) +
  ggtitle("Gráfico 3: Descomposición de la serie de Intereses\ny comisiones en el periodo 2007 - presente") +
  labs(caption="Fuente: SIGAF") +
  theme(plot.title = element_text(hjust = 0.5, face="plain"),
        plot.caption=element_text(hjust=0, vjust=0.5,
                                  margin=margin(t=1,10,10,10))) +
  scale_x_discrete(expand = c(0,0))
```

En el gráfico 3 se muestra la descomposición de la serie en sus distintos componentes. Pueden observarse, además de un crecimiento a lo largo del tiempo posterior a una disminución, los picos y las caídas en la parte estacional, esto hace a los cierres trimestrales previamente mencionados. El componente aleatorio muestra indicios de que la varaibilidad de la serie no es homogénea, sino que cambia conforme pasa el tiempo, pues durante un tiempo se mantuvo relativamente estable pero luego presenta algunos cambios.

### d.    

```{r}
data.frame(fecha=seq(ymd("2007-01-01"), ymd("2016-06-01"), by="months"),
           Original=train.serie,
           Logaritmo=log(train.serie),
           `Logaritmo.y.diferenciacion(12)`=c(rep(NA,12), diff(log(train.serie),12)),
           `Logaritmo.y.doble.diferenciacion(12)`=c(rep(NA, 13), diff(diff(log(train.serie),12),1))) %>% 
  gather(Serie, valor, -fecha) %>% 
  mutate(Serie=gsub('\\.', " ", Serie)) %>%
  mutate(Serie=factor(Serie, levels=c("Original", "Logaritmo", 
                                      "Logaritmo y diferenciacion 12 ", "Logaritmo y doble diferenciacion 12 "))) %>% 
  ggplot(., aes(x=fecha, y=valor))+
  facet_wrap(~Serie, scales="free")+
  geom_line(color = "#00AFBB", size = 0.6)+
  theme_minimal() +
  theme(text = element_text(size=9),
        axis.text.x = element_text(angle=0, hjust=1)) +
  ggtitle("Gráfico 4: Estacionarización de la serie de Intereses\ny comisiones Enero 2007 - Junio 2016") +
  labs(caption="Fuente: SIGAF",
       y="Intereses y comisiones (millones de colones)",
       x="Año") +
  theme(plot.title = element_text(hjust = 0.5, face="plain"),
        plot.caption=element_text(hjust=0, vjust=0.5,
                                  margin=margin(t=1,10,10,10))) +
  scale_x_date(expand = c(0,0))+
  scale_y_continuous(expand=c(0, 0))
```

En base a lo mostrado en el gráfico 1, la serie no parece estacionaria pues su nivel cambia con el tiempo y hay una tendencia alcista en los periodos más recientes. En el gráfico 4 se muestran los procesos de estacionarización de la serie. La figura anterior muestra que aunque a la serie se le aplique un logaritmo y una doblre diferenciación, los drásticos cambios presentes el final de la serie persisten; de nos ser por ellos, bastaría con aplicar un logaritmo para volver la serie estacionaria.

### e. 

Conviene primero hacer una identificación visual de la serie para conocer el modelo que gobierna a la misma. Para esto se muestra el autocorrelograma para estos datos considerando un logaritmo y doble diferenciación en el proceso de estacionarización. Este proceso sugiere que se tiene un $MA(1)$

```{r}
p <- acf2(diff(diff(log(train.serie),12),1), main="Grafico 6: Autocorrelación y autocorrelación parcial")
```

Para el proceso de sobreparametrización, se realizan todas las posibles permutaciones hasta 4 en la parte autoregreseiva y en la de medias móviles, tanto en la parte estacional y la no estacional. Este proceso indica que el modelo más adecuado es un $ARIMA(2,1,2)(1,1,2)_{12}$, ya que las medidas de rendimiento y criterios de información superan al $MA(1)$. El modelo seleccionado por la función `auto.arima()` es un $ARIMA(1,1,1)(0,1,0)_{12}$. Se presentan a continuación las medidas de rendimiento y criterios de información para los mejores modelos ARIMA identificados (3 primeros modelos) y el sugerido por la función `auto.arima()` para el conjunto de entrenamiento. Los criterios de información son mejores en el `auto.arima()`, sin embargo las diferencias entre los cuatro modelos no son muy grandes, mientras que los valores de las medidas de rendimiento de mayor calidad se encuentran con un $ARIMA(2,1,2)(1,1,2)_{12}$.

```{r, eval=FALSE}
g <- identificacion(4, train.serie)
arimas <- modelos.arima2(g, train.serie, "train.serie")
pos <- which(sapply(arimas,is.numeric)==F)
arimas2 <- arimas[pos]

load("C:/Users/Dell/OneDrive/Academico/Proyectos/GitHub/Academico/Cursos/SP-1633 Series Cronológicas/Examenes/Parcial II/arimas ejercicio 1.RData")
#load("D:/GitHub/Academico/Parcial2/arimas ejercicio 1.RData")

l <- list()
for(i in 1:length(arimas2)){
  l[[i]] <- medidas.arima(arimas2[[i]], test.serie, 12)
}
medidas1 <- do.call("rbind", l) %>% 
  mutate_if(is.numeric, round, 2)
tabla.latex(medidas1)

medidas3.1 <- subset(medidas1, Modelo == c("ARIMA(2,1,2)(1,1,2)[12]", "ARIMA(2,1,2)(1,1,2)[12] Validacion"))
medidas3.1$Modelo <- factor(medidas3.1$Modelo)
medidas3.2 <- subset(medidas1, Modelo == c("ARIMA(3,1,1)(4,1,0)[12]", "ARIMA(3,1,1)(4,1,0)[12] Validacion"))
medidas3.2$Modelo <- factor(medidas3.2$Modelo)
medidas3.3 <- subset(medidas1, Modelo == c("ARIMA(2,1,4)(2,0,4)[12]", "ARIMA(2,1,4)(2,0,4)[12] Validacion"))
medidas3.3$Modelo <- factor(medidas3.3$Modelo)
medidas3.4 <- subset(medidas1, Modelo == c("ARIMA(1,1,1)(0,1,0)[12]", "ARIMA(1,1,1)(0,1,0)[12] Validacion"))
medidas3.4$Modelo <- factor(medidas3.4$Modelo)
medidas.finales.arima <- do.call("rbind", list(medidas3.1,medidas3.2,medidas3.3,medidas3.4))
medidas.finales.arima$Modelo <- factor(medidas.finales.arima$Modelo)
```

\begin{tabular}{llllllll}
\toprule
Modelo & AIC & AICc & BIC & MAE & MAPE & RMSE & MASE\\
\midrule
ARIMA(2,1,2)(1,1,2)[12] & \textcolor{black}{2296.51} & \textcolor{black}{2298.07} & \textcolor{black}{2317.43} & \textcolor{red}{11937.43} & \textcolor{black}{3982.16} & \textcolor{red}{17706.04} & \textcolor{red}{0.97}\\
ARIMA(3,1,1)(4,1,0)[12] & \textcolor{black}{2301.98} & \textcolor{black}{2303.96} & \textcolor{black}{2325.51} & \textcolor{black}{12900.31} & \textcolor{black}{3580.23} & \textcolor{black}{18198.15} & \textcolor{black}{1.04}\\
ARIMA(2,1,4)(2,0,4)[12] & \textcolor{black}{2591.91} & \textcolor{black}{2595.59} & \textcolor{black}{2627.36} & \textcolor{black}{13472.85} & \textcolor{red}{3530.75} & \textcolor{black}{17979.88} & \textcolor{black}{1.09}\\
ARIMA(1,1,1)(0,1,0)[12] & \textcolor{red}{2290.61} & \textcolor{red}{2290.85} & \textcolor{red}{2298.45} & \textcolor{black}{12620.35} & \textcolor{black}{3965.15} & \textcolor{black}{18409.97} & \textcolor{black}{1.02}\\
\bottomrule
\end{tabular}

\begin{figure}[htbp]
\centering
\includegraphics{C:/Users/Dell/OneDrive/Academico/Proyectos/GitHub/Academico/Parcial2/diag1.png}
\end{figure}

### f.

Al hacer el pronóstico con los datos de validación para el mejor modelo seleccionado, el $ARIMA(2,1,2)(1,1,2)_{12}$, y el modelo seleccionado mediante la función `auto.arima()`, el $ARIMA(1,1,1)(0,1,0)_{12}$, el modelo que presenta un mejor ajuste es $ARIMA(2,1,2)(1,1,2)_{12}$.

\begin{tabular}{lllll}
\toprule
Modelo & MAE & MAPE & RMSE & MASE\\
\midrule
ARIMA(2,1,2)(1,1,2)[12] & \textcolor{blue}{13988} & \textcolor{blue}{28.03} & \textcolor{black}{23273.05} & \textcolor{blue}{1.13}\\
ARIMA(1,1,1)(0,1,0)[12]  & \textcolor{black}{14913.35} & \textcolor{black}{31.21} & \textcolor{black}{22426.29} & \textcolor{black}{1.21}\\
\bottomrule
\end{tabular}

### g.

El pronóstico a 24 meses con el ARIMA identificado y con la función `auto.arima()` logran capturar de buena manera las subidas y bajadas que se dan en al final de cada trimestre, incluso se logra ajustar un nivel moderadamente aceptable del crecimiento de manera similar a los periodos más recientes. Este es un caso en el que la estimación mediante el `auto.arima()` no ofrece resultados del todo inadecuados, pues incluso el pronóstico es bastante aceptable.

```{r, results='asis'}
modfinal <- Arima(serie.completa, c(2,1,2), c(1,1,2))
#load("C:/Users/Dell/OneDrive/Academico/Proyectos/GitHub/Academico/Cursos/SP-1633 Series Cronológicas/Artículos/Articulo 3/Arima final.Rmd.RData")
basegraf <- data.frame(fecha=seq(ymd("2007-01-01"), ymd("2020-06-01"), by="months"),
                       Original=c(serie.completa, rep(NA,24)),
                       Arima=c(forecast(modfinal, h=24)$fitted, forecast(modfinal, h=24)$mean),
                       LIarima=c(rep(NA, 138), forecast(modfinal, h=24)$lower[,2]),
                       LSarima=c(rep(NA, 138), forecast(modfinal, h=24)$upper[,2])) %>% 
  gather(Serie, numero, -c(fecha, LIarima, LSarima)) %>% 
  mutate(Serie=factor(Serie, levels = c("Original", "Regresion", "Exponencial", "Arima", "Autoarima")))

require(scales)
basegraf %>% 
  #filter(Serie %in% c("Original", "Arima")) %>% 
  ggplot(., aes(x=fecha, y=numero, colour=Serie))+
  geom_line(size = 0.8)+
  scale_color_manual(values=c("limegreen", "orangered1"))+
  geom_ribbon(aes(x=fecha, ymin=LIarima, ymax=LSarima), fill="green", linetype=0, alpha=0.2)+
  theme_minimal() +
  theme(text = element_text(size=9),
        axis.text.x = element_text(angle=0, hjust=1)) +
  ggtitle("Gráfico 6: Pronóstico de los initereses y comisiones con un ARIMA(2,1,2)(1,1,2)") +
  labs(caption="Fuente: SIGAF",
       y="Intereses y comisiones (millones de colones)",
       x="Año") +
  theme(plot.title = element_text(hjust = 0.5, face="plain"),
        plot.caption=element_text(hjust=0, vjust=0.5,
                                  margin=margin(t=1,10,10,10))) +
  scale_x_date(expand = c(0,0))+
  scale_y_continuous(expand=c(0, 0), labels = comma)
```

```{r, eval=FALSE}
kable(data.frame(forecast(modfinal, h=24))[,-c(2:3)], "latex", escape = F, booktabs = T, linesep = "")
```

\begin{tabular}{lrrr}
\toprule
  & Pronóstico & Límite inferior & Límite superior\\
\midrule
Jul 2018 & 84337.31 & 46842.47 & 121832.16\\
Ago 2018 & 26974.40 & -12489.49 & 66438.28\\
Sep 2018 & 234109.71 & 194533.08 & 273686.34\\
Oct 2018 & 94113.56 & 54539.14 & 133687.98\\
Nov 2018 & 76603.49 & 36977.16 & 116229.82\\
Dic 2018 & 123569.51 & 83861.73 & 163277.30\\
Ene 2019 & 92638.68 & 52788.36 & 132489.01\\
Feb 2019 & 29756.95 & -10293.98 & 69807.89\\
Mar 2019 & 248953.55 & 208638.94 & 289268.17\\
Abr 2019 & 122700.48 & 82060.26 & 163340.70\\
May 2019 & 74522.17 & 33496.14 & 115548.20\\
Jun 2019 & 143549.46 & 102080.75 & 185018.16\\
Jul 2019 & 102548.29 & 42038.74 & 163057.83\\
Ago 2019 & 43793.64 & -16967.74 & 104555.02\\
Sep 2019 & 257466.77 & 195872.12 & 319061.43\\
Oct 2019 & 111467.58 & 49429.60 & 173505.55\\
Nov 2019 & 96211.21 & 33422.85 & 158999.57\\
Dic 2019 & 131571.86 & 67925.70 & 195218.03\\
Ene 2020 & 113407.18 & 48741.09 & 178073.27\\
Feb 2020 & 44597.54 & -21220.41 & 110415.49\\
Mar 2020 & 273408.65 & 206314.29 & 340503.00\\
Abr 2020 & 134810.62 & 66330.84 & 203290.40\\
May 2020 & 95605.96 & 25645.24 & 165566.68\\
Jun 2020 & 156620.31 & 85096.84 & 228143.77\\
\bottomrule
\end{tabular}

```{r, results='asis'}
modfinal <- Arima(serie.completa, c(1,1,1), c(0,1,0))
#load("C:/Users/Dell/OneDrive/Academico/Proyectos/GitHub/Academico/Cursos/SP-1633 Series Cronológicas/Artículos/Articulo 3/Arima final.Rmd.RData")
basegraf <- data.frame(fecha=seq(ymd("2007-01-01"), ymd("2020-06-01"), by="months"),
                       Original=c(serie.completa, rep(NA,24)),
                       Arima=c(forecast(modfinal, h=24)$fitted, forecast(modfinal, h=24)$mean),
                       LIarima=c(rep(NA, 138), forecast(modfinal, h=24)$lower[,2]),
                       LSarima=c(rep(NA, 138), forecast(modfinal, h=24)$upper[,2])) %>% 
  gather(Serie, numero, -c(fecha, LIarima, LSarima)) %>% 
  mutate(Serie=factor(Serie, levels = c("Original", "Regresion", "Exponencial", "Arima", "Autoarima")))

require(scales)
basegraf %>% 
  #filter(Serie %in% c("Original", "Arima")) %>% 
  ggplot(., aes(x=fecha, y=numero, colour=Serie))+
  geom_line(size = 0.8)+
  scale_color_manual(values=c("limegreen", "orangered1"))+
  geom_ribbon(aes(x=fecha, ymin=LIarima, ymax=LSarima), fill="green", linetype=0, alpha=0.2)+
  theme_minimal() +
  theme(text = element_text(size=9),
        axis.text.x = element_text(angle=0, hjust=1)) +
  ggtitle("Gráfico 7: Pronóstico de los initereses y comisiones con un ARIMA(1,1,1)(0,1,0)") +
  labs(caption="Fuente: SIGAF",
       y="Intereses y comisiones (millones de colones)",
       x="Año") +
  theme(plot.title = element_text(hjust = 0.5, face="plain"),
        plot.caption=element_text(hjust=0, vjust=0.5,
                                  margin=margin(t=1,10,10,10))) +
  scale_x_date(expand = c(0,0))+
  scale_y_continuous(expand=c(0, 0), labels = comma)
```


```{r, eval=FALSE}
kable(data.frame(forecast(modfinal, h=24))[,-c(2:3)], "latex", escape = F, booktabs = T, linesep = "")
```

\begin{tabular}{lrrr}
\toprule
  & Pronóstico & Límite inferior & Límite superior\\
\midrule
Jul 2018 & 79489.44 & 40731.75 & 118247.13\\
Ago 2018 & 22419.57 & -17576.49 & 62415.62\\
Sep 2018 & 230674.24 & 189700.87 & 271647.62\\
Oct 2018 & 86125.73 & 45119.12 & 127132.33\\
Nov 2018 & 74350.82 & 33103.80 & 115597.84\\
Dic 2018 & 116567.21 & 75182.95 & 157951.48\\
Ene 2019 & 89007.30 & 47450.39 & 130564.22\\
Feb 2019 & 25262.97 & -16451.61 & 66977.55\\
Mar 2019 & 248935.12 & 207058.05 & 290812.19\\
Abr 2019 & 99913.41 & 57876.58 & 141950.24\\
May 2019 & 82512.56 & 40315.77 & 124709.36\\
Jun 2019 & 134554.93 & 92199.08 & 176910.77\\
Jul 2019 & 92882.10 & 32932.10 & 152832.10\\
Ago 2019 & 35812.15 & -24458.38 & 96082.67\\
Sep 2019 & 244066.85 & 182500.73 & 305632.98\\
Oct 2019 & 99518.32 & 37722.89 & 161313.75\\
Nov 2019 & 87743.42 & 25417.43 & 150069.42\\
Dic 2019 & 129959.81 & 67237.96 & 192681.67\\
Ene 2020 & 102399.90 & 39236.87 & 165562.94\\
Feb 2020 & 38655.57 & -24926.93 & 102238.08\\
Mar 2020 & 262327.72 & 198321.39 & 326334.05\\
Abr 2020 & 113306.01 & 48881.37 & 177730.66\\
May 2020 & 95905.16 & 31063.87 & 160746.46\\
Jun 2020 & 147947.53 & 82692.64 & 213202.42\\
\bottomrule
\end{tabular}

### h.

Dada la situación fiscal del país y la imperiosa necesidad de reducir gastos, los que se generan debido a intereses y comisiones deberían ser intervenidos para controlar el rápido ascenso que se ha presentado en los últimos años y de esta manera recuperar los niveles que se presentaban más estables al inicio de la serie.

## 2.   

### a.    

Los ingresos tributarios hacen referencia a la recaudación que obtiene el gobierno por las imposiciones fiscales que de manera única y obligatoria fija el Estado tanto a las personas físicas como jurídicas en base a la ley. Es, por tanto, todos los ingresos percibidos por concepto de impuestos.

### b.    

```{r}
#Lectura de la base

base <- read_excel("C:/Users/Dell/OneDrive/Academico/Proyectos/GitHub/Academico/Cursos/SP-1633 Series Cronológicas/Examenes/Parcial II/Datos examen2.xlsx", sheet = 3)

#base <- read_excel("D:/GitHub/Academico/Parcial2/Datos examen2.xlsx", sheet = 3)

colnames(base) <- c("fecha", "IT")
#Definición de períodos

TS <- ts(base$IT, start = c(2007, 1), end = c(2018, 6), frequency = 12)
```

```{r}
TS <- na.interp(TS, lambda="auto")
base <- mutate(base, IT=c(TS))
train <- filter(base, ymd(fecha)<=ymd("2016-06-01"))
train <- ts(train$IT, start=c(2007, 1), frequency = 12)
test <- filter(base, ymd(fecha)>=ymd("2016-07-01"))
test <- ts(test$IT, start=c(2016, 7), frequency = 12)
train.serie <- window(train, 2007)
test.serie <- window(test, 2016)
serie.completa <- window(TS, start=2007)
```

### c.

```{r}
ggplot(TS)+
  geom_line(color = "#00AFBB", size = 1.3) +
  stat_smooth(color = "#FC4E07", fill = "#FC4E07",
              method = "loess")+
  geom_vline(xintercept = 2011.6, linetype="dashed", color = "red")+
  theme_minimal() +
  theme(text = element_text(size=9),
        axis.text.x = element_text(angle=0, hjust=1)) +
  ggtitle("Gráfico 1: Ingresos tributarios del sector público\nen el periodo Enero 2007 - Junio 2018") +
  labs(caption="Fuente: SIGAF",
       y="Ingresos tributarios (millones de colones)",
       x="Año") +
  theme(plot.title = element_text(hjust = 0.5, face="plain"),
        plot.caption=element_text(hjust=0, vjust=0.5,
                                  margin=margin(t=1,10,10,10))) +
  #ylim(7,12) +
  scale_x_discrete(expand = c(0,0), limits=c(2007, 2011, 2015, 2018))+
  scale_y_continuous(expand=c(0, 0), labels = comma)
```

En el gráfico 1, al hacer un suavizamiento Loess puede observarse que la serie de ingresos tributarios del sector público tiene una tendencia al alza, la cual se sostiene incluso hasta Junio del 2018. Es a partir de Julio del 2011 (línea roja punteada) donde la tasa de cambio de esta tendencia parece crecer más rápidamente. También parece haber un cierto efecto estacional pues se observan algunos picos importantes cada cierto tiempo.

```{r}
base %>% 
  group_by(año=year(fecha), mes=month(fecha, label = TRUE, abbr=FALSE)) %>% 
  summarise(IT) %>% 
  #mutate(mes=factor(mes, labels=c("Febrero - Enero", "Marzo - Febrero",
   #                               "Abril - Marzo", "Mayo - Abril", 
    #                              "Junio - Mayo", "Julio - Junio",
     #                             "Agosto - Julio", "Setiembre - Agosto",
      #                            "Octubre - Setiembre", "Noviembre - Octubre",
       #                           "Diciembre - Noviembre", "Enero - Diciembre"))) %>% 
  ggplot(., aes(x=año, y=IT)) +
  facet_wrap(.~mes, ncol=3) +
  geom_line(color = "#00AFBB", size = 1.3) +
  stat_peaks(colour = "red") +
  stat_peaks(geom = "text", colour = "red", 
             vjust = -0.5) +
  stat_valleys(colour = "blue") +
  stat_valleys(geom = "text", colour = "blue", angle = 20,
               vjust = 0.1, hjust = 1) +
  theme_minimal() +
  theme(text = element_text(size=13),
        axis.text.x = element_text(angle=0, hjust=1)) +
  ggtitle("Gráfico 2: Ingresos tributarios del sector público\nen el periodo Enero 2007 - Junio 2018 según mes") +
  labs(caption="Fuente: SIGAF",
       y="Ingresos tributarios (millones de colones)",
       x="Año") +
  theme(plot.title = element_text(hjust = 0.5, face="plain"),
        plot.caption=element_text(hjust=0, vjust=0.5,
                                  margin=margin(t=1,10,10,10))) +
  #ylim(7, 14) +
  scale_x_discrete(expand = c(0,0), limits=c(2007, 2011, 2015, 2018))+
  scale_y_continuous(expand=c(0, 0), labels = comma)
```


El gráfico 2 muestra cómo hay un crecimiento sostenido de los Ingresos tributarios del sector público al final de cada año durante todo el periodo, mientras que se mantiene al alza casi con la misma tasa de cambio durante los demás meses. El pico más alto al inicio de la serie posiblemente se deba a un importante incremento presente en el mes de Diciembre, como lo muestra también el gráfico 2.

```{r}
base %>% 
  mutate(IT=BoxCox(c(TS), lambda=1)) %>% 
ggsdc(., aes(x = fecha, y = IT),
         method = "stl", s.window = 7, frequency = 12, type="multiplicative",
         facet.titles = c("Serie Original", "Tendencia", 
                          "Estacionalidad", "Aleatoria")) +
      geom_line(color = "#00AFBB", size = 1.3) +
  labs(x = "", y = "") +
  theme_minimal() +
  theme(text = element_text(size=13),
        axis.text.x = element_text(angle=0, hjust=1),
        plot.title = element_text(size = 12)) +
  ggtitle("Gráfico 3: Descomposición de la serie de Ingresos\ny tributarios en el periodo Enero 2007 - Junio 2018") +
  labs(caption="Fuente: SIGAF") +
  theme(plot.title = element_text(hjust = 0.5, face="plain"),
        plot.caption=element_text(hjust=0, vjust=0.5,
                                  margin=margin(t=1,10,10,10))) +
  scale_x_discrete(expand = c(0,0))+
  scale_y_continuous(expand=c(0, 0), labels = comma)
```

En el gráfico 3 se muestra la descomposición de la serie en sus distintos componentes. Pueden observarse, además de un crecimiento a lo largo del tiempo durante casi toda la serie, los picos y las caídas en la parte estacional, que corresponde al aumento en el mes de Diciembre. El componente aleatorio muestra indicios de que la varaibilidad de la serie es bastante homogénea salvo algunos pocas subidas y bajadas.    

### d.    

Al hacer uso de la función `tsoutliers()`, se pueden ubicar varios valores extremos, principalmente en los meses de Diciembre. En el siguiente cuadro se muestran los valores de los ingresos tributarios (IT), el reemplazo sugerido y su diferencia. Algunos valores del mes de Diciembre son detectados como valores extremos, sin embargo parece algo que se debe a la naturaleza de la serie, pues en Diciembre los ingresos tributarios suelen ser mayores. La única excepción puede ser en el 2008, pues en este caso los ingresos tributarios registrados son particularmente altos, incluso para ser en Diciembre, esto puede sugerir que la serie debe ser intervenida. También se detectan algunos valores atípicos meses como Marzo, Mayo y Setiembre, sin embargo estos tampoco parecen ser sistemáticos. Estos aumentos quedan también demostrados en los gráficos 1 y 2 de esta sección.    

```{r, eval=FALSE}
data.frame(base[tsoutliers(TS)$index, ], Reemplazo=tsoutliers(TS)$replacements) %>% 
  mutate(Diferencia=IT-Reemplazo) %>% 
  kable("latex", escape = F, booktabs = T, linesep = "")
```

\begin{tabular}{lrrr}
\toprule
Fecha & IT & Reemplazo & Diferencia\\
\midrule
2007-09-01 & 149542.6 & 222419.9 & -72877.28\\
2007-12-01 & 283988.4 & 345879.2 & -61890.79\\
2008-12-01 & 782833.9 & 367980.8 & 414853.14\\
2009-12-01 & 293512.9 & 371932.1 & -78419.17\\
2010-12-01 & 345501.6 & 371735.3 & -26233.67\\
2015-12-01 & 572813.9 & 506488.8 & 66325.03\\
2016-12-01 & 598180.2 & 517860.5 & 80319.68\\
2017-03-01 & 474822.1 & 395169.0 & 79653.01\\
2017-12-01 & 627474.1 & 541127.3 & 86346.84\\
2018-05-01 & 268299.8 & 331067.5 & -62767.66\\
\bottomrule
\end{tabular}

### e.    

En los puntos *b.* y *d.* de esta sección se habló acerca de los aumentos presentes en Diciembre de los Ingresos Tributarios. Entre estos aumentos, en el 2008 hubo un aumento considerablemente mayor de los ingresos tributarios, y que además se sabe que se debe a una causa externa, como lo es el pago extemporáneo de 27 empresas. Este es un caso en que resulta pertinente considerar una intervención de impulso, pues este tipo de eventos no se suelen dar en la serie.    

### f.    

Al tener presente que la serie cuenta con un fuerte componente estacional y que además cuenta con una tendencia al alza, se estiman diversas permutaciones en la parte estacional y la no estacional, considerando una diferenciación en ambas partes. De los 82 modelos que resultan importantes al utilizar la sobreparametrización, los dos mejores modelos en el conjunto de entrenamiento son un $ARIMA(0,1,1)(0,1,2)_{12}$ y un $ARIMA(2,1,2)(0,1,1)_{12}$. Se estiman además estos mismos modelos pero considerando la intervención, pues el gráfico 4 sugiere que deben haber dos intervenciones.

Dicho esto y dado el contexto de la serie, se decide hacer además de los dos mejores modelos ARIMA mencionados previamente tanto con y sin intervención de tipo escalonada, dos modelos más considerando el impulso dado en Diciembre de 2008 debido a las 27 empresas.

```{r, eval=FALSE}
identificacion2 <- function(maximo, serie, diferenciacion=NULL){
  library(foreach)
  library(doParallel)
  valores <- data.frame(p=rep(0:maximo,each=(maximo+1)**3),
                        d=0,
                        q=rep(0:maximo,each=(maximo+1)**2), 
                        P=rep(0:maximo,each=(maximo+1)), 
                        D=0,
                        Q=rep(0:maximo))
  valores2 <- valores %>% 
    mutate(d=1, D=1)
  valores3 <- valores %>% 
    mutate(D=1)
  valores4 <- valores %>% 
    mutate(d=1)
  valores <- do.call("rbind", list(valores, valores2, valores3, valores4)) %>% 
    data.frame() 
  
  if(is.null(diferenciacion)==FALSE){
    valores <- valores %>% 
      filter(d==diferenciacion[1] , D==diferenciacion[2])
  }
  
  cl<-makeCluster(detectCores())
  clusterExport(cl=cl, "train.serie")
  
  l <- parLapply(cl, X=1:nrow(valores), 
                 function(x){tryCatch({astsa::sarima(train.serie, 
                                                     p=valores[x, 1], d=valores[x,2], q=valores[x,3],
                                                     P=valores[x,4],D=valores[x,5],Q=valores[x,6], 
                                                     S=12, details = FALSE)$ttable}, 
                                      error=function(e) list(ttable=matrix(1, 2, 4)))})
  stopImplicitCluster()
  
  l2 <- sapply(l, function(y){tryCatch({y <- sum(1*(y[-nrow(y),4]>0.05), na.rm=T)}, error=function(e) 1)})
  pos <- which(l2<1)
  valores[pos,]
  
  
}
identificacion2(4, train.serie)
g2 <- identificacion2(4, train.serie, c(1,1))
arimas <- modelos.arima2(g2, train.serie, "train.serie")
pos <- which(sapply(arimas,is.numeric)==F)
arimas2 <- arimas[pos]

l <- list()
for(i in 1:length(arimas2)){
  l[[i]] <- medidas.arima(arimas2[[i]], test.serie, 12)
}
medidas1 <- do.call("rbind", l) %>% 
  mutate_if(is.numeric, round, 2)
tabla.latex(medidas1)

load("C:/Users/Dell/OneDrive/Academico/Proyectos/GitHub/Academico/Parcial2/arimas ejercicio 2.RData")
#load("D:/GitHub/Academico/Parcial2/arimas ejercicio 2.RData")

```

```{r, results='hide'}
break_point <- strucchange::breakpoints(TS ~ 1)
df=data.frame(cbind(0:5,summary(break_point)$RSS[2,]))
colnames(df)=c("Puntos de corte","BIC")
#sapply(df,class)
g1 <- ggplot(df,aes(x=`Puntos de corte`,y=BIC))+geom_line()+geom_point()+
  theme_minimal() +
  theme(text = element_text(size=9),
        axis.text.x = element_text(angle=0, hjust=1)) +
  ggtitle("Gráfico 4: Número de intervenciones") +
  labs(caption="Fuente: SIGAF",
       y="BIC",
       x="Puntos de corte") +
  theme(plot.title = element_text(hjust = 0.5, face="plain"),
        plot.caption=element_text(hjust=0, vjust=0.5,
                                  margin=margin(t=1,10,10,10))) #+
  #ylim(7,12) +
  #scale_x_discrete(expand = c(0,0), limits=c(1995, 2005, 2015))
```

```{r, results='hide'}
g2 <- autoplot(TS)+
autolayer(fitted(break_point, breaks = 2))+
  theme_minimal() +
  theme(text = element_text(size=9),
        axis.text.x = element_text(angle=0, hjust=1), legend.position = "none") +
  ggtitle("") +
  labs(caption="Fuente: SIGAF",
       y="Ingresos Tributarios (millones de colones)",
       x="Año") +
  theme(plot.title = element_text(hjust = 0.5, face="plain"),
        plot.caption=element_text(hjust=0, vjust=0.5,
                                  margin=margin(t=1,10,10,10))) +
  #ylim(7,12) +
  #scale_x_discrete(expand = c(0,0), limits=c(1995, 2005, 2015))
  scale_y_continuous(expand=c(0, 0), labels = comma)
```

```{r}
grid.arrange(g1,g2, top = "")
```
```{r, results='hide'}
l1 <- length(seq(ymd("2007-01-01"), ymd("2011-10-01"), by="months"))
l2 <- length(seq(ymd("2011-11-01"), ymd("2014-10-01"), by="months"))
l3 <- length(seq(ymd("2014-11-01"), ymd("2018-06-01"), by="months"))
level <- c(rep(0, l1), rep(1, l2), rep(2, l3))
dummy1 <- model.matrix(~as.factor(level))[, -1]
dummy2 <- c(rep(0, length(level)))
dummy2[24] <- 1
```

```{r, results='hide'}
arima1 <- Arima(train.serie, order = c(0,1,1), seasonal = list(order = c(0,1,2), period = 12), include.mean=TRUE)
arima2 <- Arima(train.serie, order = c(2,1,2), seasonal = list(order = c(0,1,1), period = 12), include.mean=TRUE)
arima.escalonado1 <- Arima(train.serie, order = c(0,1,1), seasonal = list(order = c(0,1,2), period = 12), 
                    xreg = dummy1[1:114,], include.mean=TRUE)
arima.escalonado2 <- Arima(train.serie, order = c(2,1,2), seasonal = list(order = c(0,1,1), period = 12), 
                    xreg = dummy1[1:114,], include.mean=TRUE)
arima.impulso1 <- Arima(train.serie, order = c(0,1,1), seasonal = list(order = c(0,1,2), period = 12), 
                    xreg = dummy2[1:114], include.mean=TRUE)
arima.impulso2 <- Arima(train.serie, order = c(2,1,2), seasonal = list(order = c(0,1,1), period = 12), 
                    xreg = dummy2[1:114], include.mean=TRUE)
arimas2 <- list(arima1, arima.escalonado1, arima.impulso1, 
                arima2, arima.escalonado2, arima.impulso2)

medidas.arima2 <- function(modelo, testing, horizonte, reg=NULL){
  #Nombre del modelo
  nombre <- capture.output(modelo)
  nombre <- substr(nombre[2],1, 23)
  
  #criterios de informacion
  data <- capture.output(summary(modelo))
  data <- data[grepl("AIC", data)==T]
  informacion <- strsplit(data, " ")
  pos <- which(sapply(informacion, nchar)>0)
  informacion <- informacion[[1]][pos]
  informacion <- do.call("rbind", strsplit(informacion, "=")) %>% 
    data.frame() 
  colnames(informacion) <- c("Medida", "Valor")
  informacion <- informacion %>% 
    mutate(Valor=as.numeric(as.character(Valor))) %>% 
    spread(Medida, Valor) %>% 
    data.frame(Modelo=nombre)
  
  #medidas de rendimiento
  rendimiento <- data.frame(Modelo=c(nombre, paste(nombre, "Validacion")), 
                            accuracy(forecast(modelo, horizonte, xreg=reg), testing))
  merge(informacion, rendimiento, by="Modelo", all=TRUE) %>% 
    select(Modelo, AIC, AICc, BIC, MAE, MAPE, RMSE, MASE)
}

medidas.finales <- do.call("rbind", list(medidas.arima2(arima1, test.serie, h=24),
                                         medidas.arima2(arima.escalonado1, test.serie, h=24, reg=dummy1[115:138,]),
                                         medidas.arima2(arima.impulso1, test.serie, h=24, reg=dummy2[115:138]),
                                         medidas.arima2(arima2, test.serie, h=24),
                                         medidas.arima2(arima.escalonado2, test.serie, h=24, reg=dummy1[115:138,]),
                                         medidas.arima2(arima.impulso2, test.serie, h=24, reg=dummy2[115:138]))) %>% 
  mutate_if(is.numeric, round, 2)

medidas.finales %>% 
  mutate(Modelo=as.character(Modelo),
         Modelo=c("ARIMA(0,1,1)(0,1,2)[12]", "ARIMA(0,1,1)(0,1,2)[12] Validacion", 
                  "ARIMA(0,1,1)(0,1,2)[12]Escalonada", "ARIMA(0,1,1)(0,1,2)[12]Escalonada Validacion",
                  "ARIMA(0,1,1)(0,1,2)[12]Impulso", "ARIMA(0,1,1)(0,1,2)[12]Impulso Validacion",
                  "ARIMA(2,1,2)(0,1,1)[12]", "ARIMA(2,1,2)(0,1,1)[12] Validacion", 
                  "ARIMA(2,1,2)(0,1,1)[12]Escalonada", "ARIMA(2,1,2)(0,1,1)[12]Escalonada Validacion",
                  "ARIMA(2,1,2)(0,1,1)[12]Impulso", "ARIMA(2,1,2)(0,1,1)[12]Impulso Validacion"),
         Modelo=as.factor(Modelo)) %>% 
  tabla.latex()
```

De todos los modelos estimados, el mejor resulta ser el $ARIMA(2,1,2)(0,1,1)_{12}$ con la intervención de impulso, pues presenta mejores medidas de rendimiento y de criterios de información que los demás con excepción del BIC, que es mejor en el $ARIMA(0,1,1)(0,1,2)_{12}$ con la intervención de impulso.

\begin{tabular}{llllllll}
\toprule
Modelo & AIC & AICc & BIC & MAE & MAPE & RMSE & MASE\\
\midrule
ARIMA(0,1,1)(0,1,2)[12] & \textcolor{black}{2494.09} & \textcolor{black}{2494.5} & \textcolor{black}{2504.55} & \textcolor{black}{25140.78} & \textcolor{black}{9.52} & \textcolor{black}{46536.14} & \textcolor{black}{0.72}\\
ARIMA(0,1,1)(0,1,2)[12]Escalonada & \textcolor{black}{2497.54} & \textcolor{black}{2498.43} & \textcolor{black}{2513.23} & \textcolor{black}{25207.88} & \textcolor{black}{9.57} & \textcolor{black}{46207.93} & \textcolor{black}{0.72}\\
ARIMA(0,1,1)(0,1,2)[12]Impulso & \textcolor{black}{2301.28} & \textcolor{black}{2301.91} & \textcolor{red}{2314.35} & \textcolor{black}{13480.8} & \textcolor{black}{5.88} & \textcolor{black}{18923.91} & \textcolor{black}{0.39}\\
ARIMA(2,1,2)(0,1,1)[12] & \textcolor{black}{2504.32} & \textcolor{black}{2505.22} & \textcolor{black}{2520.01} & \textcolor{black}{22961.16} & \textcolor{black}{8.81} & \textcolor{black}{45052.5} & \textcolor{black}{0.66}\\
ARIMA(2,1,2)(0,1,1)[12]Escalonada & \textcolor{black}{2508.07} & \textcolor{black}{2509.64} & \textcolor{black}{2528.99} & \textcolor{black}{22935.22} & \textcolor{black}{8.77} & \textcolor{black}{44878.74} & \textcolor{black}{0.66}\\
ARIMA(2,1,2)(0,1,1)[12]Impulso & \textcolor{red}{2297.43} & \textcolor{red}{2298.63} & \textcolor{black}{2315.74} & \textcolor{red}{13226.49} & \textcolor{red}{5.72} & \textcolor{red}{18205.32} & \textcolor{red}{0.38}\\
\bottomrule
\end{tabular}

### g.    

Al pronosticar para los siguientes 24 periodos, los mejores resultados los ofrece el $ARIMA(0,1,1)(0,1,2)_{12}$ con la interveción escalonada.

\begin{tabular}{llllllll}
\toprule
Modelo & AIC & AICc & BIC & MAE & MAPE & RMSE & MASE\\
\midrule
ARIMA(0,1,1)(0,1,2)[12] Validacion & \textcolor{white}{NA} & \textcolor{white}{NA} & \textcolor{white}{NA} & \textcolor{black}{25999.33} & \textcolor{black}{7.6} & \textcolor{black}{31390.3} & \textcolor{black}{0.75}\\
ARIMA(0,1,1)(0,1,2)[12]Escalonada Validacion & \textcolor{white}{NA} & \textcolor{white}{NA} & \textcolor{white}{NA} & \textcolor{blue}{24747.28} & \textcolor{blue}{6.87} & \textcolor{blue}{30786.75} & \textcolor{blue}{0.71}\\
ARIMA(0,1,1)(0,1,2)[12]Impulso Validacion & \textcolor{white}{NA} & \textcolor{white}{NA} & \textcolor{white}{NA} & \textcolor{black}{28768.06} & \textcolor{black}{9.08} & \textcolor{black}{35029.31} & \textcolor{black}{0.83}\\
ARIMA(2,1,2)(0,1,1)[12] Validacion & \textcolor{white}{NA} & \textcolor{white}{NA} & \textcolor{white}{NA} & \textcolor{black}{29317.49} & \textcolor{black}{8.51} & \textcolor{black}{34425.79} & \textcolor{black}{0.84}\\
ARIMA(2,1,2)(0,1,1)[12]Escalonada Validacion & \textcolor{white}{NA} & \textcolor{white}{NA} & \textcolor{white}{NA} & \textcolor{black}{28596.98} & \textcolor{black}{8.03} & \textcolor{black}{34322.88} & \textcolor{black}{0.82}\\
ARIMA(2,1,2)(0,1,1)[12]Impulso Validacion & \textcolor{white}{NA} & \textcolor{white}{NA} & \textcolor{white}{NA} & \textcolor{black}{29912.15} & \textcolor{black}{9.48} & \textcolor{black}{35946.47} & \textcolor{black}{0.86}\\
\bottomrule
\end{tabular}

### h.    

El pronóstico a 24 para ambos modelos logra capturar de buena manera las subidas y bajadas de la serie, particularmente las presentes en Diciembre. Es el modelo que considera la intervención por impulso, el $ARIMA(2,1,2)(0,1,1)_{12}$, el que logra capturar de mejor manera los picos presentes al final de cada año. El $ARIMA(0,1,1)(0,1,2)_{12}$, que involucra una intervención por la sugerencia de escalonamiento hecha en apartados anteriores, es un poco más deficiente para detectar los puntos altos de la serie, pues muchas veces los subestima e incluso en otras los sobreestima.

```{r, results='asis'}
modfinal <- Arima(serie.completa, order = c(2,1,2), seasonal = list(order = c(0,1,1), period = 12), 
                    xreg = dummy2[1:138], include.mean=TRUE)
#load("C:/Users/Dell/OneDrive/Academico/Proyectos/GitHub/Academico/Cursos/SP-1633 Series Cronológicas/Artículos/Articulo 3/Arima final.Rmd.RData")
basegraf <- data.frame(fecha=seq(ymd("2007-01-01"), ymd("2020-06-01"), by="months"),
                       Original=c(serie.completa, rep(NA,24)),
                       Arima=c(forecast(modfinal, h=24, xreg = dummy2[115:138])$fitted, 
                               forecast(modfinal, h=24, xreg = dummy2[115:138])$mean),
                       LIarima=c(rep(NA, 138), forecast(modfinal, h=24, xreg = dummy2[115:138])$lower[,2]),
                       LSarima=c(rep(NA, 138), forecast(modfinal, h=24, xreg = dummy2[115:138])$upper[,2])) %>% 
  gather(Serie, numero, -c(fecha, LIarima, LSarima)) %>% 
  mutate(Serie=factor(Serie, levels = c("Original", "Regresion", "Exponencial", "Arima", "Autoarima")))

require(scales)
basegraf %>% 
  #filter(Serie %in% c("Original", "Arima")) %>% 
  ggplot(., aes(x=fecha, y=numero, colour=Serie))+
  geom_line(size = 0.8)+
  scale_color_manual(values=c("limegreen", "orangered1"))+
  geom_ribbon(aes(x=fecha, ymin=LIarima, ymax=LSarima), fill="green", linetype=0, alpha=0.2)+
  theme_minimal() +
  theme(text = element_text(size=9),
        axis.text.x = element_text(angle=0, hjust=1)) +
  ggtitle("Gráfico 6: Pronóstico de los Ingresos Tributarios con un ARIMA(2,1,2)(0,1,1)") +
  labs(caption="Fuente: SIGAF",
       y="Ingresos Tributarios (millones de colones)",
       x="Año") +
  theme(plot.title = element_text(hjust = 0.5, face="plain"),
        plot.caption=element_text(hjust=0, vjust=0.5,
                                  margin=margin(t=1,10,10,10))) +
  scale_x_date(expand = c(0,0))+
  scale_y_continuous(expand=c(0, 0), labels = comma)
```

```{r, eval=FALSE}
kable(data.frame(forecast(modfinal, h=24, xreg = dummy2[115:138]))[,-c(2:3)], "latex", escape = F, booktabs = T, linesep = "")
```

\begin{tabular}{lrrr}
\toprule
  & Point.Forecast & Lo.95 & Hi.95\\
\midrule
Jul 2018 & 323304.8 & 283699.6 & 362909.9\\
Ago 2018 & 279311.5 & 238293.9 & 320329.1\\
Sep 2018 & 386656.4 & 345598.8 & 427714.0\\
Oct 2018 & 325785.1 & 279195.0 & 372375.3\\
Nov 2018 & 335002.7 & 287186.5 & 382818.9\\
Dic 2018 & 625786.3 & 576950.2 & 674622.4\\
Ene 2019 & 374631.7 & 323303.0 & 425960.5\\
Feb 2019 & 291478.1 & 238829.0 & 344127.1\\
Mar 2019 & 473338.8 & 419318.7 & 527359.0\\
Abr 2019 & 349648.0 & 293915.9 & 405380.1\\
May 2019 & 290132.7 & 233058.7 & 347206.7\\
Jun 2019 & 428823.9 & 370371.1 & 487276.7\\
Jul 2019 & 327049.0 & 257434.9 & 396663.0\\
Ago 2019 & 294054.6 & 221828.9 & 366280.3\\
Sep 2019 & 396292.9 & 322748.5 & 469837.3\\
Oct 2019 & 334191.0 & 255984.3 & 412397.7\\
Nov 2019 & 346721.8 & 266142.7 & 427300.9\\
Dic 2019 & 635555.7 & 552776.8 & 718334.7\\
Ene 2020 & 384343.6 & 298522.6 & 470164.6\\
Feb 2020 & 302141.0 & 214009.5 & 390272.6\\
Mar 2020 & 483304.6 & 392863.2 & 573745.9\\
Abr 2020 & 359701.9 & 266781.7 & 452622.1\\
May 2020 & 300443.9 & 205304.5 & 395583.4\\
Jun 2020 & 438898.2 & 341546.3 & 536250.1\\
\bottomrule
\end{tabular}



```{r, results='asis'}
arima.escalonado1 <- Arima(train.serie, order = c(0,1,1), seasonal = list(order = c(0,1,2), period = 12), 
                    xreg = dummy1[1:114,], include.mean=TRUE)
modfinal <- Arima(serie.completa, order = c(0,1,1), seasonal = list(order = c(0,1,2), period = 12), 
                    xreg = dummy1[1:138,], include.mean=TRUE)
#load("C:/Users/Dell/OneDrive/Academico/Proyectos/GitHub/Academico/Cursos/SP-1633 Series Cronológicas/Artículos/Articulo 3/Arima final.Rmd.RData")
basegraf <- data.frame(fecha=seq(ymd("2007-01-01"), ymd("2020-06-01"), by="months"),
                       Original=c(serie.completa, rep(NA,24)),
                       Arima=c(forecast(modfinal, h=24, xreg = dummy1[115:138,])$fitted, 
                               forecast(modfinal, h=24, xreg = dummy1[115:138,])$mean),
                       LIarima=c(rep(NA, 138), forecast(modfinal, h=24, xreg = dummy1[115:138,])$lower[,2]),
                       LSarima=c(rep(NA, 138), forecast(modfinal, h=24, xreg = dummy1[115:138,])$upper[,2])) %>% 
  gather(Serie, numero, -c(fecha, LIarima, LSarima)) %>% 
  mutate(Serie=factor(Serie, levels = c("Original", "Regresion", "Exponencial", "Arima", "Autoarima")))

require(scales)
basegraf %>% 
  #filter(Serie %in% c("Original", "Arima")) %>% 
  ggplot(., aes(x=fecha, y=numero, colour=Serie))+
  geom_line(size = 0.8)+
  scale_color_manual(values=c("limegreen", "orangered1"))+
  geom_ribbon(aes(x=fecha, ymin=LIarima, ymax=LSarima), fill="green", linetype=0, alpha=0.2)+
  theme_minimal() +
  theme(text = element_text(size=9),
        axis.text.x = element_text(angle=0, hjust=1)) +
  ggtitle("Gráfico 7: Pronóstico de los Ingresos Tributarios con un ARIMA(2,1,2)(0,1,1)") +
  labs(caption="Fuente: SIGAF",
       y="Ingresos Tributarios (millones de colones)",
       x="Año") +
  theme(plot.title = element_text(hjust = 0.5, face="plain"),
        plot.caption=element_text(hjust=0, vjust=0.5,
                                  margin=margin(t=1,10,10,10))) +
  scale_x_date(expand = c(0,0))+
  scale_y_continuous(expand=c(0, 0), labels = comma)
```

```{r, eval=FALSE}
kable(data.frame(forecast(modfinal, h=24, xreg = dummy2[115:138,]))[,-c(2:3)], "latex", escape = F, booktabs = T, linesep = "")
```

\begin{tabular}{lrrr}
\toprule
  & Point.Forecast & Lo.95 & Hi.95\\
\midrule
Jul 2018 & 338157.9 & 244881.9 & 431434.0\\
Ago 2018 & 313760.7 & 220221.7 & 407299.8\\
Sep 2018 & 412706.5 & 318905.2 & 506507.9\\
Oct 2018 & 344617.8 & 250554.9 & 438680.8\\
Nov 2018 & 356107.7 & 261783.9 & 450431.4\\
Dic 2018 & 619116.9 & 524533.0 & 713700.8\\
Ene 2019 & 375268.7 & 280425.4 & 470111.9\\
Feb 2019 & 324003.7 & 228901.8 & 419105.6\\
Mar 2019 & 486557.2 & 391197.3 & 581917.2\\
Abr 2019 & 357315.9 & 261698.7 & 452933.1\\
May 2019 & 326592.5 & 230718.6 & 422466.3\\
Jun 2019 & 444067.0 & 347937.3 & 540196.8\\
Jul 2019 & 344546.0 & 247881.1 & 441210.9\\
Ago 2019 & 325438.7 & 228502.6 & 422374.9\\
Sep 2019 & 423651.0 & 326444.3 & 520857.6\\
Oct 2019 & 356545.4 & 259069.1 & 454021.8\\
Nov 2019 & 372739.2 & 274993.9 & 470484.5\\
Dic 2019 & 653716.5 & 555702.9 & 751730.1\\
Ene 2020 & 400089.6 & 301808.7 & 498370.6\\
Feb 2020 & 331022.1 & 232474.3 & 429569.8\\
Mar 2020 & 508686.6 & 409872.7 & 607500.4\\
Abr 2020 & 376743.0 & 277663.8 & 475822.1\\
May 2020 & 331787.7 & 232443.9 & 431131.5\\
Jun 2020 & 464349.4 & 364741.7 & 563957.1\\
\bottomrule
\end{tabular}

### i.    

```{r}
X2i <- read_excel("2i.xlsx")

X2i %>% 
  select(Año, Gastos, Ingresos) %>% 
  filter(Año>=ymd("2007-01-01") & Año<=ymd("2018-06-01")) %>% 
  mutate(mes=month(Año, label=TRUE, abbr = FALSE)) %>% 
  gather(`Gasto/Ingreso`, valor, -c(Año, mes)) %>% 
  ggplot(., aes(x=as.Date(Año), y=valor, colour=`Gasto/Ingreso`))+
  geom_line() +
  facet_wrap("mes", nrow=4, ncol=3)+
  #geom_vline(xintercept = 2011.6, linetype="dashed", color = "red")+
  theme_minimal() +
  theme(text = element_text(size=9),
        axis.text.x = element_text(angle=0, hjust=1)) +
  ggtitle("Gráfico 8: Tasa de cambio de los gastos\ne Ingresos tributarios Enero 2007 - Junio 2018") +
  labs(caption="Fuente: SIGAF",
       y="Gastos / Ingresos (Porcentaje)",
       x="Año") +
  theme(plot.title = element_text(hjust = 0.5, face="plain"),
        plot.caption=element_text(hjust=0, vjust=0.5,
                                  margin=margin(t=1,10,10,10)))+ 
  #ylim(7,12) +
  scale_x_date(expand = c(0,0))+
  scale_y_continuous(expand=c(0, 0))
```

Al comparar la tasa de cambio promedio para los gastos contra la tasa de cambio promedio para los ingresos tributarios, puede verse entre 2008 y 2009 la tasa de cambio es mayor para los ingresos tributarios, mientras que desde 2009 esta situación se invierte, pues la tasa de cambio promedio de los gastos totales se mantiene siempre mayor para cada uno de los meses. Es a partir de Junio del año 2011 que ambas tasas de cambio tienden a estabilizarse, alcanzando valores similares entre sí, manteniendo esta situación hasta Junio del año 2018.